-- ChaosFX_Server.lua
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")

-- Cria o RemoteEvent se não existir
local re = ReplicatedStorage:FindFirstChild("ChaosFXEvent")
if not re then
    re = Instance.new("RemoteEvent")
    re.Name = "ChaosFXEvent"
    re.Parent = ReplicatedStorage
end

-- Funções de efeitos globais
local function broadcastExplosion(pos)
    for _, plr in ipairs(Players:GetPlayers()) do
        local char = plr.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local e = Instance.new("Explosion")
            e.Position = pos
            e.BlastRadius = 20
            e.BlastPressure = 0
            e.Parent = workspace
        end
    end
end

local function broadcastLightning(origin, target)
    for _, plr in ipairs(Players:GetPlayers()) do
        local a0 = Instance.new("Part", workspace)
        a0.Anchored = true; a0.CanCollide = false; a0.Transparency = 1; a0.Size = Vector3.new(0.2,0.2,0.2)
        a0.Position = origin
        local a1 = Instance.new("Part", workspace)
        a1.Anchored = true; a1.CanCollide = false; a1.Transparency = 1; a1.Size = Vector3.new(0.2,0.2,0.2)
        a1.Position = target
        local beam = Instance.new("Beam")
        local at0 = Instance.new("Attachment", a0)
        local at1 = Instance.new("Attachment", a1)
        beam.Attachment0 = at0; beam.Attachment1 = at1
        beam.LightEmission = 1; beam.Width0 = 2; beam.Width1 = 0.6
        beam.Brightness = 5; beam.FaceCamera = true
        beam.Parent = a0
        Debris:AddItem(a0, 0.35)
        Debris:AddItem(a1, 0.35)
    end
end

local function broadcastFlashbang()
    for _, plr in ipairs(Players:GetPlayers()) do
        local gui = plr:FindFirstChildOfClass("PlayerGui")
        if gui then
            local f = Instance.new("Frame")
            f.BackgroundColor3 = Color3.new(1,1,1)
            f.BorderSizePixel = 0
            f.Size = UDim2.fromScale(1,1)
            f.BackgroundTransparency = 1
            f.Parent = gui
            TweenService:Create(f, TweenInfo.new(0.1), {BackgroundTransparency = 0}):Play()
            Debris:AddItem(f, 3)
        end
    end
end

-- Recebe eventos do cliente
re.OnServerEvent:Connect(function(player, data)
    if typeof(data) ~= "table" then return end
    if data.cmd == "Explosion" then
        broadcastExplosion(data.pos)
    elseif data.cmd == "Lightning" then
        broadcastLightning(data.origin, data.target)
    elseif data.cmd == "Flashbang" then
        broadcastFlashbang()
    end
end)
